// prisma/core/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../../apps/web/src/db/core"
}

datasource db {
  provider = "mongodb"
  url      = env("CORE_MONGODB_URI")
}

//
// ---------- ENUMS ----------
enum ContentKind {
  SWIPE
  EVENT
  SUNDAY_POLL
}

enum PublishStatus {
  draft
  review
  published
  archived
}

enum RegionMode {
  AUTO
  MANUAL
}

enum Locale {
  de
  en
  fr
  it
  es
  pl
  uk
  ru
  tr
  hi
  zh
  ar
}

enum Stance {
  FOR
  AGAINST
  NEUTRAL
}

enum UnitKind {
  claim
  opinion
  policy
  question
  prediction
}

enum ReviewStatus {
  OPEN
  IN_PROGRESS
  VERIFIED
  REFUTED
  MIXED
  STALE
  ARCHIVED
}

enum Interest {
  interested
  ignored
  undecided
}

enum Triage {
  none
  watchlist
  escalate
}

// --- Stream & Source Enums (ADD) ---
enum SourceKind {
  USER      // direkte User-Einsendung
  NEWS      // News/Crawler
  SOCIAL    // Social API
  API       // Partner-API
  SYSTEM    // interne Jobs
}

enum StreamKind {
  EVENT     // fachliche Events (ContributionCreated, VoteCast, ...)
  METRIC    // Kennzahlen, Zähler
  LOG       // Prozess-/Workflow-Logs
}

enum StreamStatus {
  ACCEPTED
  APPLIED
  REJECTED
}

//
/// ---------- CONTENT / TOPIC / TAG ----------
model Topic {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  slug        String     @unique
  title       String
  description String?
  locale      Locale     @default(de)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  items ContentItem[]
  tags  TopicTag[]

  @@index([locale])
  @@index([createdAt])
}

model Tag {
  id     String  @id @default(auto()) @map("_id") @db.ObjectId
  slug   String  @unique
  label  String
  topics TopicTag[]
  items  ItemTag[]
}

model TopicTag {
  id      String @id @default(auto()) @map("_id") @db.ObjectId  // Mongo: keine Composite-IDs
  topicId String @db.ObjectId
  tagId   String @db.ObjectId

  topic Topic @relation(fields: [topicId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tag   Tag   @relation(fields: [tagId],   references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([topicId, tagId])
  @@index([topicId])
  @@index([tagId])
}

model ItemTag {
  id     String @id @default(auto()) @map("_id") @db.ObjectId   // Mongo: keine Composite-IDs
  itemId String @db.ObjectId
  tagId  String @db.ObjectId

  item ContentItem @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tag  Tag         @relation(fields: [tagId],  references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([itemId, tagId])
  @@index([itemId])
  @@index([tagId])
}

/// ---------- REGION + CLOSURE ----------
model Region {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  code      String   @unique
  name      String
  level     Int
  parentId  String?  @db.ObjectId
  parent    Region?  @relation("RegionHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  Region[] @relation("RegionHierarchy")
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations zu ContentItem
  itemsManual    ContentItem[] @relation("ItemRegionManual")
  itemsEffective ContentItem[] @relation("ItemRegionEffective")

  // Closure-Table
  ancestors   RegionClosure[] @relation("RegionAncestor")
  descendants RegionClosure[] @relation("RegionDescendant")

  @@index([level])
}

model RegionClosure {
  id            String  @id @default(auto()) @map("_id") @db.ObjectId
  ancestorId    String  @db.ObjectId
  descendantId  String  @db.ObjectId
  depth         Int

  ancestor   Region @relation("RegionAncestor",   fields: [ancestorId],   references: [id], onDelete: NoAction, onUpdate: NoAction)
  descendant Region @relation("RegionDescendant", fields: [descendantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([ancestorId, descendantId])
  @@index([ancestorId, depth])
  @@index([descendantId, depth])
}

/// ---------- CONTENT ITEMS ----------
model ContentItem {
  id      String      @id @default(auto()) @map("_id") @db.ObjectId
  kind    ContentKind

  topicId String   @db.ObjectId
  topic   Topic    @relation(fields: [topicId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  locale    Locale          @default(de)
  title     String?
  text      String
  richText  String?
  sortOrder Int             @default(0) @map("order")

  units    ExtractedUnit[]

  status     PublishStatus @default(draft)
  authorName String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  publishAt DateTime?
  expireAt  DateTime?

  regionMode        RegionMode @default(AUTO)
  regionManualId    String?    @db.ObjectId
  regionManual      Region?    @relation("ItemRegionManual",    fields: [regionManualId],    references: [id], onDelete: NoAction, onUpdate: NoAction)
  regionAuto        Json?
  regionEffectiveId String?    @db.ObjectId
  regionEffective   Region?    @relation("ItemRegionEffective", fields: [regionEffectiveId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  validation Json?
  meta       Json?

  answerOptions AnswerOption[]
  tags          ItemTag[]

  @@index([kind, status, locale])
  @@index([publishAt])
  @@index([topicId])
  @@index([regionEffectiveId])
  @@index([createdAt])
}

model AnswerOption {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  itemId    String      @db.ObjectId
  item      ContentItem @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  label     String
  value     String
  sortOrder Int         @default(0) @map("order")
  exclusive Boolean     @default(false)
  meta      Json?

  @@unique([itemId, sortOrder])
  @@unique([itemId, value])
}

/// ---------- FACT-CHECK DOMAIN ----------
model FactcheckJob {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  jobId          String   @unique
  contributionId String
  status         String   // PENDING | PROCESSING | COMPLETED | FAILED
  tokensUsed     Int      @default(0)
  durationMs     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  claims  FactcheckClaim[]
  results FactcheckResult[]

  @@index([status, createdAt])
}

model FactcheckClaim {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  jobId           String   @db.ObjectId
  text            String
  language        String?
  topic           String?
  falsifiable     Boolean  @default(true)
  frames          String[] @default([])
  rhetoricalFlags String[] @default([])

  canonicalKey String       @unique
  scope        String?
  timeframe    String?
  status       ReviewStatus @default(OPEN)

  job             FactcheckJob     @relation(fields: [jobId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  providerRuns    ProviderRun[]
  evidences       Evidence[]
  consensus       ConsensusRun?
  verdictVersions VerdictVersion[]
  units           ExtractedUnit[]
  finding         Finding?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId, createdAt])
  @@index([status, updatedAt])
}

model ProviderRun {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  claimId    String   @db.ObjectId
  provider   String
  verdict    String
  confidence Float
  costTokens Int      @default(0)
  latencyMs  Int      @default(0)
  raw        Json
  createdAt  DateTime @default(now())

  claim FactcheckClaim @relation(fields: [claimId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([claimId, provider])
  @@index([createdAt])
}

model ConsensusRun {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  claimId        String   @unique @db.ObjectId
  method         String
  verdict        String
  confidence     Float
  balanceScore   Float
  diversityIndex Float
  providers      Json
  createdAt      DateTime @default(now())

  claim FactcheckClaim @relation(fields: [claimId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Evidence {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  claimId      String    @db.ObjectId
  url          String
  domain       String
  stance       Stance
  snapshotHash String?
  firstSeenAt  DateTime? @default(now())
  trustScore   Int?

  claim FactcheckClaim @relation(fields: [claimId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([claimId, domain])
}

model VerdictVersion {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  claimId    String   @db.ObjectId
  verdict    String
  confidence Float
  asOf       DateTime @default(now())
  supersedes String?

  claim FactcheckClaim @relation(fields: [claimId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([claimId, asOf])
}

model FactcheckResult {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  jobId     String   @db.ObjectId
  verdict   String
  rawOutput Json
  createdAt DateTime @default(now())

  job FactcheckJob @relation(fields: [jobId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([jobId, createdAt])
}

model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  entityType String
  entityId   String
  action     String
  actor      String
  at         DateTime @default(now())
  meta       Json

  @@index([entityType, at])
}

/// ---------- ERWEITERUNG: Extracted Units & Findings ----------
model ExtractedUnit {
  id     String       @id @default(auto()) @map("_id") @db.ObjectId

  // V2-Relation (optional für V1-Kompatibilität)
  itemId String?      @db.ObjectId
  item   ContentItem? @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // V1-Feld: externer/Mongo Statement-Ref (optional)
  statementId String?

  kind       UnitKind
  text       String
  spanStart  Int
  spanEnd    Int
  confidence Float

  // Deduplizierung
  canonicalKey String
  scope        String?
  timeframe    String?

  // Verknüpfung auf Prisma-Claim
  claimId String?       @db.ObjectId
  claim   FactcheckClaim? @relation(fields: [claimId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  interest   Interest @default(undecided)
  triage     Triage   @default(none)
  editorNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kind, canonicalKey])
  @@index([interest, triage])
  @@index([itemId])
  @@index([statementId])
}

model Finding {
  id      String         @id @default(auto()) @map("_id") @db.ObjectId

  // 1:1 – Finding hält den FK auf Claim (stabil & eindeutig)
  claimId String         @unique @db.ObjectId
  claim   FactcheckClaim @relation(fields: [claimId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  summary               String
  outcome               String   // LIKELY_TRUE | LIKELY_FALSE | MIXED | UNDETERMINED
  rationale             String
  metrics               Json?
  comparedJurisdictions Json?
  lastChecked           DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

/// ---------- ADMIN SETTINGS (Singleton) ----------
model AdminSettings {
  id         String   @id @default("global") @map("_id")     // feste ID
  onboarding Json?
  csp        Json?
  updatedAt  DateTime @updatedAt
}

/// --- SUPPORT & MANDATE -------------------------------------------------------
model Supporter {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String   @unique
  firstName    String
  lastName     String
  phone        String?
  postalCode   String?
  city         String?
  countryCode  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  intents      SupportIntent[]
  mandates     SepaMandate[]
  newsletter   NewsletterSubscription?
}

model SupportIntent {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  persona      String
  cycle        String?
  amountCents  Int?
  persons      Int?
  pledgeTopic  String?
  skills       String?
  source       String?
  createdAt    DateTime @default(now())

  supporterId  String   @db.ObjectId
  supporter    Supporter @relation(fields: [supporterId], references: [id])
}

model SepaMandate {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  creditorId     String
  mandateRef     String   @unique
  ibanMasked     String
  ibanHash       String
  bic            String?
  consentAt      DateTime
  ipAddress      String?
  signatureName  String
  signatureType  String
  validFrom      DateTime
  revokedAt      DateTime?

  supporterId    String   @db.ObjectId
  supporter      Supporter @relation(fields: [supporterId], references: [id])
}

model NewsletterSubscription {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  supporterId  String   @unique @db.ObjectId
  supporter    Supporter @relation(fields: [supporterId], references: [id])

  subscribed   Boolean  @default(true)
  token        String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

