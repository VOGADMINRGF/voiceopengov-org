// apps/landing/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Personen mit minimalen Stammdaten (DSGVO-konform – keine unnötigen Felder)
model Supporter {
  id         String                  @id @default(uuid())
  email      String                  @unique @db.Citext  // case-insensitive Email (Postgres citext)
  firstName  String                  @default("")
  lastName   String                  @default("")
  createdAt  DateTime                @default(now())

  // 1:1 – eine aktive Newsletter-Subscription pro Supporter
  newsletter NewsletterSubscription?
  leads      ChapterLead[]

  @@index([createdAt])
}

/// Double-Opt-In Status
model NewsletterSubscription {
  supporterId  String  @unique
  supporter    Supporter @relation(fields: [supporterId], references: [id], onDelete: Cascade)

  // Einmal-Token für Bestätigung; nach erfolgreicher Bestätigung wird es auf NULL gesetzt
  token         String?  @unique

  subscribed    Boolean  @default(true)  // Anforderung (angefragt)
  confirmedAt   DateTime?
  unsubscribedAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

/// Leads für Chapter/City-Teams usw.
model ChapterLead {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())

  email       String   @db.Citext
  countryCode String
  postal      String?
  city        String?
  locale      String?
  intent      String   @default("FOUND")
  message     String?
  processedAt DateTime?

  supporterId String?
  supporter   Supporter? @relation(fields: [supporterId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([countryCode, city])
}

/// Auditing (frei für alle Landing-APIs)
model AuditLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  actor     String?
  action    String
  payload   Json?
  ip        String?
  userAgent String?

  @@index([createdAt])
  @@index([action])
}
